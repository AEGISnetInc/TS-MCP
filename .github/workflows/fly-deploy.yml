# See https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/

name: Deploy to Fly

on:
  push:
    branches:
      - main

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest
    concurrency: deploy-group

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all commits to check messages

      - name: Check for [run ci] in commit messages
        id: check_ci
        run: |
          # Get commit messages from this push
          COMMIT_MESSAGES=$(git log --format=%s ${{ github.event.before }}..${{ github.sha }} 2>/dev/null || git log --format=%s -1)
          echo "Commit messages:"
          echo "$COMMIT_MESSAGES"

          if echo "$COMMIT_MESSAGES" | grep -q '\[run ci\]'; then
            echo "Found [run ci] in commit messages"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "No [run ci] found in commit messages, skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Fly CLI
        if: steps.check_ci.outputs.should_deploy == 'true'
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly
        if: steps.check_ci.outputs.should_deploy == 'true'
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deployment skipped
        if: steps.check_ci.outputs.should_deploy == 'false'
        run: echo "Deployment skipped - no [run ci] in commit messages"
